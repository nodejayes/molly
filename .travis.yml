language: node_js
node_js:
- '9'
notifications:
  email: markusgilg@outlook.de
env:
  global:
    - MONGO_VERSION=4.0.0
# make mongodb a replica set
before_script:
- mkdir -p downloads
- mkdir -p var/db var/log
- if [[ ! -d downloads/mongodb-linux-x86_64-ubuntu1604-${MONGO_VERSION} ]] ; then cd downloads && wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1604-${MONGO_VERSION}.tgz && tar xzf mongodb-linux-x86_64-ubuntu1604-${MONGO_VERSION}.tgz && cd ..; fi
- downloads/mongodb-linux-x86_64-ubuntu1604-${MONGO_VERSION}/bin/mongod --version
- downloads/mongodb-linux-x86_64-ubuntu1604-${MONGO_VERSION}/bin/mongod --dbpath var/db --replSet rs0 --fork --logpath var/log/mongod.log
- sleep 10
- |-
  downloads/mongodb-linux-x86_64-ubuntu1604-${MONGO_VERSION}/bin/mongo --eval "rs.initiate({_id: 'rs0', members:[{_id: 0, host: '127.0.0.1:27017'}]});"
  sleep 15
jobs:
  include:
  - stage: build
    script: npm run build
  - stage: test
    script: npm run coverage
deploy:
  provider: npm
  email: markusgilg@outlook.de
  skip_cleanup: true
  api_key:
    secure: sE1uBa2IJHWjfyU61G6fwOYwkhe51GDZv22Q2FS9aF9vSJugk4RY979GkYdhaXQKB8yvWDGjzsT4WnZC8Ajej/kDOTpVZU4KZGf4/uf2uxTmUmatCuEsqgh70Uia4NsXyPb3ZPCPcMH95wLCQ37EdPRp43ev7jh10HE0ylQ5w3v2usxQwoKLdWYmh7+NqpcizUulnHFU0KDPuruJAc5Aa6VkJApyADgaixZgUQq8LhVsJLnaPoWeS82fA6DHLLAuHVDTSaOBwKcqofsS4QHuoLKVcrHGHWUigkrcnmSNdaxlREv+CVODL0ZEhr93d2MUiYpQ1I1Zt8aR/OrarjKDMc/f3cklZPNkGGBvV4iU0puyLN1I6zElJci9AY/wnvkP6fMJwmje9v95+ZCQVyqnhhvftf6zhWDUN2UAy2M7gUKeSiUDifHd1j8MTy5wl9oDJWFz8aGUtlgumXbTHQWus2FjSXBQHD5DtIB/UM7Labmb4uD8FjJN5iQiMiwo8cd/4qIiN0/+MXuQNQhqlbad6eUGJf+Wtehw7J5EnJi9y4yJ6tiHPkb9OTR5BjAvtw/nXP0OaeOL4I8feWgZ2HzuFY7xhbpujirs16q0pwKBkk/+CEj/2RM0qlRWcpmDqvfm3yOkySh5rEsoVWRWukrBztlsBCdDleChvw2uCzwveN8=
  on:
    branch: master
    repo: nodejayes/molly
